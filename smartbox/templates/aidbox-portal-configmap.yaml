{{- if .Values.aidboxPortal.enabled }}
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "smartbox.fullname" . }}-portal-init-bundle
  labels:
    {{- include "smartbox.labels" . | nindent 4 }}
    app.kubernetes.io/component: aidbox-portal
data:
  init-bundle.json: |
    {
      "resourceType": "Bundle",
      "type": "transaction",
      "entry": [
        {
          "resource": {
            "hl7.fhir.us.core#6.1.0": "https://packages.simplifier.net/hl7.fhir.us.core/6.1.0",
            "us-core-extensions.legacy.aidbox#0.0.0": "https://storage.googleapis.com/aidbox-public/smartbox/us-core-extensions.legacy.aidbox.tar.gz"
          },
          "request": {
            "method": "POST",
            "url": "/$upload-fhir-npm-packages"
          }
        },
        {
          "resource": {
            "resourceType": "FHIRSchema",
            "url": "http://aidbox.app/StructureDefinition/Client/created-by",
            "id": "client-created-by",
            "base": "Extension",
            "name": "client-created-by",
            "kind": "complex-type",
            "type": "Extension",
            "version": "0.0.1",
            "elements": {
              "url": {
                "fixed": "http://aidbox.app/StructureDefinition/Client/created-by"
              },
              "value": {
                "choices": ["valueReference"]
              },
              "valueReference": {
                "type": "Reference",
                "refers": ["User"],
                "choiceOf": "value"
              }
            },
            "derivation": "constraint"
          },
          "request": {
            "method": "PUT",
            "url": "FHIRSchema/client-created-by"
          }
        },
        {
          "resource": {
            "resourceType": "SearchParameter",
            "id": "Client.created-by",
            "url": "http://aidbox.app/StructureDefinition/Client/created-by",
            "name": "created-by",
            "status": "active",
            "code": "created-by",
            "base": ["Client"],
            "type": "token",
            "description": "Client created-by User",
            "expression": "Client.meta.extension.where(url='http://aidbox.app/StructureDefinition/Client/created-by').value.Reference.id"
          },
          "request": {
            "method": "PUT",
            "url": "SearchParameter/Client.created-by"
          }
        },
        {
          "resource": {
            "resourceType": "FHIRSchema",
            "url": "http://aidbox.app/StructureDefinition/Client/status",
            "id": "client-status",
            "base": "Extension",
            "name": "client-status",
            "kind": "complex-type",
            "type": "Extension",
            "version": "0.0.2",
            "elements": {
              "url": {
                "fixed": "http://aidbox.app/StructureDefinition/Client/status"
              },
              "value": {
                "choices": ["valueCode"]
              },
              "valueCode": {
                "type": "code",
                "choiceOf": "value",
                "constraints": {
                  "enum-client-status": {
                    "severity": "error",
                    "expression": "%context.subsetOf('draft' | 'review' | 'active' | 'rejected')"
                  }
                }
              }
            },
            "derivation": "constraint"
          },
          "request": {
            "method": "PUT",
            "url": "FHIRSchema/client-status"
          }
        },
        {
          "resource": {
            "resourceType": "SearchParameter",
            "id": "Client.status",
            "url": "http://aidbox.app/StructureDefinition/Client/status",
            "name": "status",
            "status": "active",
            "code": "status",
            "base": ["Client"],
            "type": "token",
            "description": "Client status (draft, review, active, rejected)",
            "expression": "Client.meta.extension.where(url='http://aidbox.app/StructureDefinition/Client/status').value.code"
          },
          "request": {
            "method": "PUT",
            "url": "SearchParameter/Client.status"
          }
        },
        {
          "_comment": "OAuth Client for Admin Portal",
          "resource": {
            "resourceType": "Client",
            "id": "smartbox-admin-portal",
            "first_party": true,
            "grant_types": ["code"],
            "scope": ["openid", "profile", "email"],
            "auth": {
              "authorization_code": {
                "redirect_uri": "https://{{ .Values.domain.adminPortal }}/api/admin/auth/callback",
                "access_token_expiration": 3600,
                "token_format": "jwt",
                "pkce": true,
                "refresh_token": true,
                "refresh_token_expiration": 86400
              }
            }
          },
          "request": {
            "method": "PUT",
            "url": "Client/smartbox-admin-portal"
          }
        },
        {
          "resource": {
            "resourceType": "AccessPolicy",
            "id": "admin-api",
            "engine": "matcho",
            "description": "Scoped access for admin API client (sessions, orgs, clients, users, tos/privacy)",
            "matcho": {
              "client": {"id": "admin-api"},
              "$one-of": [
                {
                  "params": {"resource/type": "Session"},
                  "operation": {"id": {"$one-of": ["FhirCreate", "FhirSearch", "FhirRead", "FhirUpdate", "FhirPatch"]}}
                },
                {
                  "params": {"resource/type": "Organization"},
                  "operation": {"id": {"$one-of": ["FhirSearch", "FhirRead"]}}
                },
                {
                  "params": {"resource/type": "Client"},
                  "operation": {"id": {"$one-of": ["FhirSearch", "FhirRead"]}}
                },
                {
                  "params": {"resource/type": "User"},
                  "operation": {"id": "FhirRead"}
                },
                {
                  "params": {
                    "resource/type": "DocumentReference",
                    "resource/id": {"$one-of": ["smartbox-tos", "smartbox-privacy"]}
                  },
                  "operation": {"id": {"$one-of": ["FhirRead", "FhirUpdate", "FhirCreate"]}}
                }
              ]
            }
          },
          "request": {
            "method": "PUT",
            "url": "AccessPolicy/admin-api"
          }
        },
        {
          "resource": {
            "resourceType": "SearchParameter",
            "id": "Communication.about",
            "url": "http://smartbox.hs/sp/Communication-about",
            "name": "communication-about",
            "status": "active",
            "code": "about",
            "base": ["Communication"],
            "type": "reference",
            "description": "Search Communication by Communication.about (any reference, incl. Aidbox system resources)",
            "expression": "Communication.about"
          },
          "request": {
            "method": "PUT",
            "url": "SearchParameter/Communication.about"
          }
        },
        {
          "resource": {
            "resourceType": "SearchParameter",
            "id": "Session.client",
            "url": "http://smartbox.hs/sp/Session-client",
            "name": "session-client",
            "status": "active",
            "code": "client",
            "base": ["Session"],
            "type": "reference",
            "description": "Search Session by client reference",
            "expression": "Session.client",
            "target": ["Client"]
          },
          "request": {
            "method": "PUT",
            "url": "SearchParameter/Session.client"
          }
        },
        {
          "resource": {
            "roles": [{"type": "admin"}]
          },
          "request": {
            "method": "PATCH",
            "url": "User/admin"
          }
        },
        {
          "resource": {
            "resourceType": "AccessPolicy",
            "id": "allow-read-settings",
            "engine": "matcho",
            "description": "Allow admin-api client to read Aidbox settings",
            "matcho": {
              "client": {"id": "admin-api"},
              "uri": {"$one-of": ["/api/v1/settings/introspect", "^/api/v1/settings/.*"]}
            }
          },
          "request": {
            "method": "PUT",
            "url": "AccessPolicy/allow-read-settings"
          }
        },
        {
          "request": {
            "method": "PUT",
            "url": "AccessPolicy/smart-app-can-read-patient-api"
          },
          "resource": {
            "engine": "matcho",
            "matcho": {
              "jwt": {"atv": 2, "scope": "present?", "context": {"patient": "present?"}},
              "client": {"type": "smart-app", "active": true}
            },
            "id": "smart-app-can-read-patient-api",
            "resourceType": "AccessPolicy"
          }
        },
        {
          "request": {
            "method": "PUT",
            "url": "AccessPolicy/patient-can-get-launch-uri"
          },
          "resource": {
            "resourceType": "AccessPolicy",
            "id": "patient-can-get-launch-uri",
            "type": "rpc",
            "engine": "matcho-rpc",
            "rpc": {
              "aidbox.smart/get-launch-uri": {
                "user": {"fhirUser": {"resourceType": "Patient"}}
              }
            }
          }
        }
      ]
    }
{{- end }}

