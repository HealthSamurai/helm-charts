{
  "resourceType": "Bundle",
  "type": "transaction",
  "entry": [
    {
      "_comment": "Upload required FHIR packages",
      "resource": {
        "hl7.fhir.us.core#6.1.0": "https://packages.simplifier.net/hl7.fhir.us.core/6.1.0",
        "us-core-extensions.legacy.aidbox#0.0.0": "https://storage.googleapis.com/aidbox-public/smartbox/us-core-extensions.legacy.aidbox.tar.gz"
      },
      "request": {
        "method": "POST",
        "url": "/$upload-fhir-npm-packages"
      }
    },
    {
      "_comment": "Load sample test data for developers",
      "resource": {
        "source": "https://storage.googleapis.com/aidbox-public/smartbox/all_data.ndjson.gz"
      },
      "request": {
        "method": "POST",
        "url": "/$load"
      }
    },
    {
      "resource": {
        "resourceType": "FHIRSchema",
        "url": "http://aidbox.app/StructureDefinition/Client/created-by",
        "id": "client-created-by",
        "base": "Extension",
        "name": "client-created-by",
        "kind": "complex-type",
        "type": "Extension",
        "version": "0.0.1",
        "elements": {
          "url": {
            "fixed": "http://aidbox.app/StructureDefinition/Client/created-by"
          },
          "value": {
            "choices": [
              "valueReference"
            ]
          },
          "valueReference": {
            "type": "Reference",
            "refers": [
              "User"
            ],
            "choiceOf": "value"
          }
        },
        "derivation": "constraint"
      },
      "request": {
        "method": "PUT",
        "url": "FHIRSchema/client-created-by"
      }
    },
    {
      "resource": {
        "resourceType": "SearchParameter",
        "id": "Client.created-by",
        "url": "http://aidbox.app/StructureDefinition/Client/created-by",
        "name": "created-by",
        "status": "active",
        "code": "created-by",
        "base": [
          "Client"
        ],
        "type": "token",
        "description": "Client created-by User",
        "expression": "Client.meta.extension.where(url='http://aidbox.app/StructureDefinition/Client/created-by').value.Reference.id"
      },
      "request": {
        "method": "PUT",
        "url": "SearchParameter/Client.created-by"
      }
    },
    {
      "resource": {
        "resourceType": "FHIRSchema",
        "url": "http://aidbox.app/StructureDefinition/Client/status",
        "id": "client-status",
        "base": "Extension",
        "name": "client-status",
        "kind": "complex-type",
        "type": "Extension",
        "version": "0.0.2",
        "elements": {
          "url": {
            "fixed": "http://aidbox.app/StructureDefinition/Client/status"
          },
          "value": {
            "choices": [
              "valueCode"
            ]
          },
          "valueCode": {
            "type": "code",
            "choiceOf": "value",
            "constraints": {
              "enum-client-status": {
                "severity": "error",
                "expression": "%context.subsetOf('draft' | 'review' | 'active' | 'rejected')"
              }
            }
          }
        },
        "derivation": "constraint"
      },
      "request": {
        "method": "PUT",
        "url": "FHIRSchema/client-status"
      }
    },
    {
      "resource": {
        "resourceType": "SearchParameter",
        "id": "Client.status",
        "url": "http://aidbox.app/StructureDefinition/Client/status",
        "name": "status",
        "status": "active",
        "code": "status",
        "base": [
          "Client"
        ],
        "type": "token",
        "description": "Client status (draft, review, active, rejected)",
        "expression": "Client.meta.extension.where(url='http://aidbox.app/StructureDefinition/Client/status').value.code"
      },
      "request": {
        "method": "PUT",
        "url": "SearchParameter/Client.status"
      }
    },
    {
      "_comment": "OAuth Client for Developer Portal - UPDATE redirect_uri with your domain",
      "resource": {
        "resourceType": "Client",
        "id": "smartbox-developer-portal",
        "first_party": true,
        "grant_types": [
          "code"
        ],
        "scope": [
          "openid",
          "profile",
          "email"
        ],
        "auth": {
          "authorization_code": {
            "redirect_uri": "https://portal-sandbox.yourdomain.com/api/developer/auth/callback",
            "access_token_expiration": 3600,
            "token_format": "jwt",
            "pkce": true,
            "refresh_token": true,
            "refresh_token_expiration": 86400
          }
        }
      },
      "request": {
        "method": "PUT",
        "url": "Client/smartbox-developer-portal"
      }
    },
    {
      "_comment": "Link admin user to test patient for sandbox testing",
      "resource": {
        "fhirUser": {
          "reference": "Patient/test-pt-1"
        }
      },
      "request": {
        "method": "PATCH",
        "url": "User/admin"
      }
    },
    {
      "request": {
        "method": "PUT",
        "url": "AccessPolicy/dev-can-get-launch-uri"
      },
      "resource": {
        "resourceType": "AccessPolicy",
        "id": "dev-can-get-launch-uri",
        "type": "rpc",
        "engine": "matcho-rpc",
        "rpc": {
          "aidbox.smart/get-launch-uri": {
            "user": {
              "fhirUser": {
                "resourceType": "Patient"
              }
            }
          }
        }
      }
    },
    {
      "request": {
        "method": "PUT",
        "url": "AccessPolicy/dev-smart-app-read"
      },
      "resource": {
        "resourceType": "AccessPolicy",
        "id": "dev-smart-app-read",
        "type": "rest",
        "engine": "matcho",
        "matcho": {
          "client": {
            "type": "smart-app"
          },
          "operation": {
            "id": {
              "$one-of": [
                "FhirSearch",
                "FhirRead"
              ]
            }
          }
        }
      }
    },
    {
      "resource": {
        "resourceType": "AccessPolicy",
        "id": "developer-api",
        "engine": "matcho",
        "description": "Scoped access for developer API client (sessions, oauth state, orgs, users)",
        "matcho": {
          "client": {
            "id": "developer-api"
          },
          "$one-of": [
            {
              "params": {
                "resource/type": "Session"
              },
              "operation": {
                "id": {
                  "$one-of": [
                    "FhirCreate",
                    "FhirSearch",
                    "FhirRead",
                    "FhirUpdate",
                    "FhirPatch"
                  ]
                }
              }
            },
            {
              "params": {
                "resource/type": "Organization"
              },
              "operation": {
                "id": {
                  "$one-of": [
                    "FhirSearch",
                    "FhirRead"
                  ]
                }
              }
            },
            {
              "params": {
                "resource/type": "User"
              },
              "operation": {
                "id": "FhirRead"
              }
            }
          ]
        }
      },
      "request": {
        "method": "PUT",
        "url": "AccessPolicy/developer-api"
      }
    },
    {
      "request": {
        "method": "PUT",
        "url": "AccessPolicy/dev-client-search-own"
      },
      "resource": {
        "resourceType": "AccessPolicy",
        "id": "dev-client-search-own",
        "engine": "matcho",
        "description": "Developers can search only their own Client apps",
        "matcho": {
          "user": {
            "roles": {
              "$contains": {
                "type": "developer"
              }
            }
          },
          "operation": {
            "id": "FhirSearch"
          },
          "params": {
            "resource/type": "Client",
            "created-by": ".user.id"
          }
        }
      }
    },
    {
      "request": {
        "method": "PUT",
        "url": "AccessPolicy/dev-client-read-write-own"
      },
      "resource": {
        "resourceType": "AccessPolicy",
        "id": "dev-client-read-write-own",
        "engine": "sql",
        "sql": {
          "query": "select true from client where id = {{params.resource/id}}\n  and exists (\n  select 1\n  from jsonb_array_elements(resource->'meta'->'extension') ext\nwhere ext->>'url' = 'http://aidbox.app/StructureDefinition/Client/created-by'\n  and ext #>> '{value,Reference,id}' = {{user.id}});"
        }
      }
    },
    {
      "request": {
        "method": "PUT",
        "url": "AccessPolicy/developer-user-read-self"
      },
      "resource": {
        "resourceType": "AccessPolicy",
        "id": "developer-user-read-self",
        "engine": "matcho",
        "description": "Developers can read only their own User resource",
        "matcho": {
          "user": {
            "roles": {
              "$contains": {
                "type": "developer"
              }
            }
          },
          "operation": {
            "id": "FhirRead"
          },
          "params": {
            "resource/type": "User",
            "resource/id": ".user.id"
          }
        }
      }
    },
    {
      "request": {
        "method": "PUT",
        "url": "AccessPolicy/admin-review-sandbox-clients"
      },
      "resource": {
        "resourceType": "AccessPolicy",
        "id": "admin-review-sandbox-clients",
        "engine": "matcho",
        "description": "Admins can review sandbox Clients (read/search only)",
        "matcho": {
          "user": {
            "roles": {
              "$contains": {
                "type": "admin"
              }
            }
          },
          "params": {
            "resource/type": "Client"
          },
          "operation": {
            "id": {
              "$one-of": [
                "FhirSearch",
                "FhirRead"
              ]
            }
          }
        }
      }
    },
    {
      "request": {
        "method": "PUT",
        "url": "AccessPolicy/admin-role-access"
      },
      "resource": {
        "resourceType": "AccessPolicy",
        "id": "admin-role-access",
        "description": "Role-based access policy for administrators - allows full system access",
        "engine": "matcho",
        "matcho": {
          "user": {
            "roles": {
              "contains": {
                "type": "admin"
              }
            }
          }
        }
      }
    },
    {
      "request": {
        "method": "PUT",
        "url": "AccessPolicy/patient-role-access"
      },
      "resource": {
        "resourceType": "AccessPolicy",
        "id": "patient-role-access",
        "description": "Role-based access policy for patients - allows access to own data and consent management",
        "engine": "matcho",
        "matcho": {
          "user": {
            "roles": {
              "contains": {
                "type": "patient"
              }
            }
          },
          "operation": {
            "id": {
              "$one-of": [
                "FhirSearch",
                "FhirRead",
                "FhirPatch",
                "FhirCreate",
                "FhirUpdate"
              ]
            }
          },
          "$or": [
            {
              "params": {
                "resource/type": "Patient"
              },
              "operation": {
                "id": {
                  "$one-of": [
                    "FhirRead"
                  ]
                }
              }
            },
            {
              "params": {
                "resource/type": "Consent"
              },
              "operation": {
                "id": {
                  "$one-of": [
                    "FhirSearch",
                    "FhirRead",
                    "FhirPatch",
                    "FhirCreate",
                    "FhirUpdate"
                  ]
                }
              }
            }
          ]
        }
      }
    },
    {
      "_comment": "Email template for developer signup - UPDATE redirect URL with your domain",
      "request": {
        "method": "PUT",
        "url": "NotificationTemplate/auth-signup-email"
      },
      "resource": {
        "resourceType": "NotificationTemplate",
        "template": "\n<h3>Confirm your email address </h3>\n<p>Hello {{params.data.name}}{{params.email}}{{params.username}}!</p>\n<p>We just need to verify that {{params.email}} {{params.username}} is your email address.</p>\n<p><a target=\"_blank\" href=\"{{params.base-url}}/auth/signup/confirm/{{id}}?redirect_to=YOUR_BASE64_ENCODED_REDIRECT_URL\">Confirm Email Address</a></p> \n<b>Didn't request this email?</b>\n<p>No worries! Your address may have been entered by mistake. If you ignore or delete this email, nothing further will happen.</p>\n<p>If you're having problems, please feel free to contact us. We'll be glad to help.</p> "
      }
    },
    {
      "_comment": "Token introspector for cross-Aidbox authentication - UPDATE with your admin Aidbox domain",
      "request": {
        "method": "PUT",
        "url": "TokenIntrospector/admin-aidbox"
      },
      "resource": {
        "resourceType": "TokenIntrospector",
        "id": "admin-aidbox",
        "type": "jwt",
        "jwt": {
          "iss": "https://aidbox.yourdomain.com"
        },
        "jwks_uri": "https://aidbox.yourdomain.com/.well-known/jwks.json"
      }
    },
    {
      "_comment": "Allow requests from admin Aidbox - UPDATE issuer with your admin Aidbox domain",
      "request": {
        "method": "PUT",
        "url": "AccessPolicy/allow-admin-tokens"
      },
      "resource": {
        "resourceType": "AccessPolicy",
        "id": "allow-admin-tokens",
        "description": "Allow requests authenticated with Admin Aidbox JWT tokens",
        "engine": "json-schema",
        "schema": {
          "required": [
            "jwt"
          ],
          "properties": {
            "jwt": {
              "required": [
                "iss"
              ],
              "properties": {
                "iss": {
                  "constant": "https://aidbox.yourdomain.com"
                }
              }
            }
          }
        }
      }
    },
    {
      "request": {
        "method": "PUT",
        "url": "AccessPolicy/dev-client-search-communication"
      },
      "resource": {
        "engine": "matcho",
        "matcho": {
          "user": {
            "roles": {
              "$contains": {
                "type": "developer"
              }
            }
          },
          "params": {
            "resource/type": "Communication",
            ".about.0.reference": "present?"
          },
          "operation": {
            "id": "FhirSearch"
          }
        },
        "description": "Developers can search communication for certain app",
        "id": "dev-client-search-communication",
        "resourceType": "AccessPolicy"
      }
    },
    {
      "request": {
        "method": "PUT",
        "url": "AccessPolicy/smart-app-can-read-patient-api"
      },
      "resource": {
        "engine": "matcho",
        "matcho": {
          "jwt": {
            "atv": 2,
            "scope": "present?",
            "context": {
              "patient": "present?"
            }
          },
          "client": {
            "type": "smart-app",
            "active": true
          }
        },
        "id": "smart-app-can-read-patient-api",
        "resourceType": "AccessPolicy"
      }
    }
  ]
}

