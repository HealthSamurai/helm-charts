# =============================================================================
# FHIR App Portal Ingress
# =============================================================================
# Routes traffic to Admin Portal and Developer Portal.
# IMPORTANT: Update all hostnames with your actual domains.
# =============================================================================

apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: fhir-app-portal-ingress
  annotations:
    # =========================================================================
    # SSL/TLS Configuration
    # =========================================================================
    # Use cert-manager to automatically provision SSL certificates
    cert-manager.io/cluster-issuer: "letsencrypt"

    # Force HTTPS redirects
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
    nginx.ingress.kubernetes.io/force-ssl-redirect: "true"

    # =========================================================================
    # Host Header Configuration (CRITICAL for domain routing)
    # =========================================================================
    # Preserve the original Host header so nginx inside pod can route correctly
    nginx.ingress.kubernetes.io/upstream-vhost: "$host"
    nginx.ingress.kubernetes.io/preserve-host: "true"

    # =========================================================================
    # CORS Configuration
    # =========================================================================
    # Enable Cross-Origin Resource Sharing
    nginx.ingress.kubernetes.io/enable-cors: "true"
    nginx.ingress.kubernetes.io/cors-allow-methods: "GET, POST, PUT, DELETE, OPTIONS"
    nginx.ingress.kubernetes.io/cors-allow-origin: "*"

    # =========================================================================
    # Performance & Compression
    # =========================================================================
    # Enable gzip compression
    nginx.ingress.kubernetes.io/enable-gzip: "true"

    # =========================================================================
    # Rate Limiting
    # =========================================================================
    # Limit to 100 requests per second per IP
    nginx.ingress.kubernetes.io/limit-rps: "100"

    # =========================================================================
    # Timeout Configuration
    # =========================================================================
    # Increase timeouts for long-running requests
    nginx.ingress.kubernetes.io/proxy-connect-timeout: "300"
    nginx.ingress.kubernetes.io/proxy-send-timeout: "300"
    nginx.ingress.kubernetes.io/proxy-read-timeout: "300"

spec:
  ingressClassName: nginx

  # ===========================================================================
  # TLS Configuration
  # ===========================================================================
  # cert-manager will automatically create and manage certificates
  # IMPORTANT: Update hostnames with your actual domains
  tls:
  - hosts:
    - portal.yourdomain.com
    - portal-sandbox.yourdomain.com
    secretName: fhir-portal-tls  # Auto-created by cert-manager

  # ===========================================================================
  # Routing Rules
  # ===========================================================================
  # IMPORTANT: Update hostnames with your actual domains
  rules:
  # Admin Portal
  - host: portal.yourdomain.com
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: fhir-app-portal
            port:
              number: 8095

  # Developer Portal (Sandbox)
  - host: portal-sandbox.yourdomain.com
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: fhir-app-portal
            port:
              number: 8096

